利用AI（元宝）来帮我们写ORACLE触发器和生成测试用例







```sql
CREATE OR REPLACE TRIGGER TRG_ENCRYPT_MOBILE
BEFORE INSERT OR UPDATE ON your_table
FOR EACH ROW
DECLARE
    V_TEMP_MOBILE VARCHAR2(2000);  -- 临时变量，用于保存原始传入的mobile_no值
BEGIN
    -- 强制清空明文字段（合规要求）
    V_TEMP_MOBILE := :NEW.mobile_no;  -- 捕获传入的mobile_no值
    :NEW.mobile_no := NULL;           -- 始终置空mobile_no字段[3](@ref)

    -- 根据传入的mobile_no判断加密逻辑
    IF V_TEMP_MOBILE IS NOT NULL THEN
        -- 逻辑1：传入mobile_no非空时，加密并写入mobile_no_encry
        :NEW.mobile_no_encry := FUNC_ENCRYPTION(V_TEMP_MOBILE);  -- 调用加密函数[1,3](@ref)
    ELSE
        -- 逻辑2：传入mobile_no为空时，根据update_by处理
        :NEW.mobile_no_encry := NULL;  -- 默认清空加密字段

        -- 仅当update_by='kettle_clean'且为UPDATE操作时保留原值
        IF :NEW.update_by = 'kettle_clean' AND UPDATING THEN
            :NEW.mobile_no_encry := :OLD.mobile_no_encry;  -- 保留原加密值
            :NEW.update_by := :OLD.update_by;               -- 保留原update_by值（防覆盖）[8](@ref)
        END IF;
    END IF;
END;
/
```



| ​**操作类型**​   | ​传入 mobile_no | ​传入 update_by  | ​原 mobile_no_encry | ​原 update_by | ​最终 mobile_no | ​最终 mobile_no_encry | ​最终 update_by​ | ​**说明**​            |
|:------------ | ------------- | -------------- | ------------------ | ------------ | ------------- | ------------------- | -------------- | ------------------- |
| ​**INSERT**​ | '13800138000' | 'user1'        | （无旧值）              | （无旧值）        | NULL          | 加密后的值（如'A1B2C3'）    | 'user1'        | 明文非空，加密写入           |
| ​**INSERT**​ | NULL          | 'kettle_clean' | （无旧值）              | （无旧值）        | NULL          | NULL                | 'kettle_clean' | 无明文且INSERT操作，无旧值可保留 |
| ​**UPDATE**​ | NULL          | 'kettle_clean' | 'A1B2C3'           | 'admin'      | NULL          | 'A1B2C3'            | 'admin'        | 保留原加密值和原update_by   |
| ​**UPDATE**​ | NULL          | 'user2'        | 'A1B2C3'           | 'admin'      | NULL          | NULL                | 'user2'        | 非kettle_clean，清空加密值 |
| ​**UPDATE**​ | '13900139000' | 'user3'        | 'A1B2C3'           | 'admin'      | NULL          | 加密后的新值（如'D4E5F6'）   | 'user3'        | 传入新明文，加密覆盖旧值        |






